<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Friends Sidebar</title>
    {% load static %}
	{% load custom_filters %}
    <link rel="stylesheet" href="{% static 'css/facebookhome.css' %}">
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
	<style>
		:root{
			--fb-blue: #1877F2;
			--hover-bg: #F0F2F5;
			--online: #31A24C;
			--text: #050505;
		}
		/* Container to demonstrate a right sidebar column */
		body{font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; margin:16px; color:var(--text)}
		.right-sidebar{width:460px}
		.friends-panel{background:#fff;border-radius:10px;padding:14px 16px;box-shadow:0 6px 18px rgba(3,19,35,0.08);}
		.panel-title{font-size:16px;font-weight:600;margin:6px 8px 12px}

		/* Row */
		.friend-row{display:flex;align-items:center;justify-content:space-between;height:56px;padding:8px 12px;border-radius:8px;cursor:default;transition:background .12s ease,transform .08s ease}
		.friend-row:hover{background:var(--hover-bg);transform:translateY(-1px)}
		.left{display:flex;align-items:center;gap:12px;min-width:0;flex:1}

		/* Avatar */
		.avatar{position:relative;width:44px;height:44px;border-radius:50%;flex:0 0 44px;display:flex;align-items:center;justify-content:center;overflow:hidden;font-weight:700;color:#fff}
		.avatar img{width:44px;height:44px;object-fit:cover;border-radius:50%;display:block}
		.avatar-initials{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px}

		/* Online dot */
		.online-dot{position:absolute;width:10px;height:10px;border-radius:50%;background:var(--online);border:2px solid #fff;right:-4px;bottom:-4px;box-shadow:0 0 0 2px rgba(0,0,0,0.04)}

		/* Name */
		.name{font-size:15px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

		/* Button (Facebook style) */
		.request-btn{background:var(--fb-blue);color:#fff;border:0;padding:8px 14px;border-radius:8px;font-weight:600;font-size:14px;box-shadow:0 4px 8px rgba(24,119,242,0.18);cursor:pointer;min-width:150px;transition:background .12s ease,transform .06s ease;}
		.request-btn:hover{background:#166FE5}
		.request-btn:active{transform:translateY(1px)}
		.request-btn:focus{outline:3px solid rgba(24,119,242,0.18);outline-offset:2px}
		.request-btn[disabled]{background:#E7F3FF;color:#6B8FCF;cursor:default;box-shadow:none;border-radius:8px}

		/* Small modal */
		.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;align-items:center;justify-content:center;z-index:999}
		.modal{background:#fff;border-radius:10px;padding:18px;width:460px;box-shadow:0 12px 36px rgba(3,19,35,0.12);}
		.modal p{margin:0 0 16px;font-size:15px}
		.modal .controls{display:flex;justify-content:flex-end;gap:8px}
		.btn-cancel{background:transparent;border:0;padding:8px 12px;border-radius:6px;cursor:pointer}
		.btn-send{background:var(--fb-blue);color:#fff;border:0;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:600}

		/* Responsive demo container - center the friends panel vertically */
		.demo-wrap{display:flex;flex-direction:column;gap:16px;align-items:center}

		/* small utility spacing */
		.spacer{flex:1}
	</style>
</head>
<body>

    <header class="header">
        <!-- Left section -->
        <div class="header-left">
            <div class="logo">
                <i class="fab fa-facebook"></i>
            </div>
            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Search Facebook">
            </div>
        </div>

        <!-- Center navigation -->
        <div class="header-center">
            <a href="{% url 'Homepage' %}" class="nav-icon ">
                <i class="fas fa-home"></i>
            </a>
            <a href="video_page" class="nav-icon">
                <i class="fas fa-play"></i>
            </a>
            <a href="market_page" class="nav-icon">
                <i class="fas fa-store"></i>
            </a>
            <a href="friends_page" class="nav-icon active">
                <i class="fas fa-users"></i>
            </a>
            <a href="#" class="nav-icon">
                <i class="fas fa-gamepad"></i>
            </a>
        </div>

        <!-- Right section -->
        <div class="header-right">
            <div class="action-button">
                <i class="fas fa-plus"></i>
            </div>
            <div class="action-button">
                <a href="message_page" style="color:#aaa;"><i class="fab fa-facebook-messenger"></i></a>
            </div>
            <div class="action-button">
                <a href="requests_page" style="color:#aaa;"><i class="fas fa-bell"></i></a>
            </div>
            <div class="user-profile">
                <a href="{% url 'User_Profile' %}"><img src="{% static "image/contact1.jpeg" %}" alt="Profile"></a>
            </div>
        </div>
    </header>
    <br><br><br>
	<div class="demo-wrap">
		<!-- Title for global search -->
		<div style="width:100%;text-align:left;margin-bottom:8px;align-self:stretch;padding-left:16px;">
			<h2 style="margin-top:0">Global Search Friends</h2>
		</div>

		<!-- Right sidebar -->
		<aside class="right-sidebar">
			<div class="friends-panel" role="complementary" aria-label="People you may know">
				<div class="panel-title">People You May Know</div>
				
				<!-- Friend rows rendered from server -->
				<div class="friends-list">
					{% for user in users %}
						<div class="friend-row">
							<div class="left">
								<!-- Avatar with initials -->
								<div class="avatar">
									<div class="avatar-initials" style="background:#6C5CE7">
										{{ user.first_name|default:""|slice:":1"|upper }}{{ user.last_name|default:""|slice:":1"|upper }}
									</div>
								</div>
								<div class="name">{{ user.get_full_name|default:user.username }}</div>
							</div>

							<!-- Action Button -->
							{% if user.id in friend_ids %}
								<button class="request-btn" disabled>Friends</button>
							{% elif user.id in outgoing_ids %}
								<button class="request-btn" disabled>Request Sent</button>
							{% elif user.id in incoming_ids %}
								<button class="request-btn" data-fr-id="{{ incoming_map|get_item:user.id }}" data-user-id="{{ user.id }}" onclick="acceptRequest(this, event)">Confirm</button>
							{% else %}
								<button class="request-btn" data-user-id="{{ user.id }}" onclick="openModal(this, '{{ user.get_full_name|default:user.username }}', event)">Add Friend</button>
							{% endif %}
						</div>
					{% empty %}
						<div style="padding:12px;color:#6b7280;text-align:center">No users available</div>
					{% endfor %}
				</div>
			</div>
		</aside>
	</div>

	<!-- Modal -->
	<div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
		<div class="modal" role="document">
			<p id="modalText">Send friend request?</p>
			<div class="controls">
				<button class="btn-cancel" onclick="closeModal()">Cancel</button>
				<button class="btn-send" onclick="sendRequest()">Send</button>
			</div>
		</div>
	</div>

	<script>
		let activeUserId = null;

		function getCookie(name) {
			const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
			return v ? v.pop() : '';
		}

		function openModal(btn, userName, e) {
			e.preventDefault();
			activeUserId = btn.dataset.userId;
			document.getElementById('modalText').textContent = `Send friend request to ${userName}?`;
			document.getElementById('modalBackdrop').style.display = 'flex';
			document.querySelector('.btn-send').focus();
		}

		function closeModal() {
			document.getElementById('modalBackdrop').style.display = 'none';
			activeUserId = null;
		}

		function sendRequest() {
			if (!activeUserId) return;
			
			const csrftoken = getCookie('csrftoken');
			const body = new URLSearchParams();
			body.append('to_id', String(activeUserId));

			fetch('/api/send_request/', {
				method: 'POST',
				credentials: 'same-origin',
				headers: {
					'X-CSRFToken': csrftoken,
					'Content-Type': 'application/x-www-form-urlencoded'
				},
				body: body.toString(),
			}).then(resp => {
				if(resp.ok) {
					closeModal();
					setTimeout(() => location.reload(), 300);
				} else {
					alert('Failed to send request');
				}
			}).catch(err => {
				alert('Network error');
			});
		}

		function acceptRequest(btn, e) {
			e.preventDefault();
			const frId = btn.dataset.frId;
			if (!frId) return;
			
			const csrftoken = getCookie('csrftoken');
			fetch('/api/accept_request/', {
				method: 'POST',
				credentials: 'same-origin',
				headers: {'X-CSRFToken': csrftoken, 'Content-Type': 'application/x-www-form-urlencoded'},
				body: `fr_id=${encodeURIComponent(frId)}`
			}).then(resp => {
				if(resp.ok) location.reload();
			});
		}

		// Close modal on Escape key
		document.addEventListener('keydown', (e) => {
			if (e.key === 'Escape') closeModal();
		});

		// Close modal on backdrop click
		document.getElementById('modalBackdrop').addEventListener('click', (e) => {
			if (e.target === document.getElementById('modalBackdrop')) closeModal();
		});
	</script>
</body>
</html>

