{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Messages</title>
    <link rel="stylesheet" href="{% static 'css/facebookhome.css' %}" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <style>
      /* Messenger layout styles */
      :root {
        --bg: #f1f5f7;
        --card: #ffffff;
        --muted: #6b7280;
        --accent: #0b84ff;
        --text: #0b1220;
      }

      body.dark-mode {
        --bg: #0f0f0f;
        --card: #1a1a1a;
        --muted: #888888;
        --text: #e0e0e0;
      }

      body {
        background: var(--bg);
        font-family: Inter, system-ui, Arial, sans-serif;
        color: var(--text);
        transition: background 0.3s, color 0.3s;
      }

      .spacer {
        height: 20px;
      }

      /* Dark mode toggle */
      .theme-toggle {
        position: fixed;
        top: 80px;
        right: 20px;
        background: var(--card);
        border: 1px solid #e0e0e0;
        padding: 8px 12px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        z-index: 100;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        color: var(--text);
        transition: all 0.3s;
      }

      body.dark-mode .theme-toggle {
        border-color: #333;
        color: #ffffff;
      }

      /* Two-panel layout: fixed contacts column + flexible chat column. Full-width on desktop. */
      .msger-wrap {
        width: 100%;
        max-width: none;
        margin: 12px 0;
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 12px;
        padding: 12px;
        box-sizing: border-box;
      }

      .contacts {
        background: var(--card);
        border-radius: 12px;
        box-shadow: 0 8px 30px rgba(2, 6, 23, 0.06);
        overflow: hidden;
        height: calc(100vh - 140px);
        color: var(--text);
      }
      .contacts-header {
        padding: 18px 18px 8px 18px;
        border-bottom: 1px solid #eef2f6;
      }

      body.dark-mode .contacts-header {
        border-bottom-color: #333;
      }

      .contacts-header h3 {
        margin: 0;
        font-size: 18px;
      }

      .contacts-list {
        height: calc(100% - 72px);
        overflow: auto;
      }
      .contact-item {
        display: flex;
        gap: 12px;
        padding: 12px 16px;
        align-items: center;
        cursor: pointer;
        border-bottom: 1px solid #f2f4f6;
        transition: background 0.2s;
      }

      body.dark-mode .contact-item {
        border-bottom-color: #333;
      }

      .contact-item:hover {
        background: #f9f9f9;
      }

      body.dark-mode .contact-item:hover {
        background: #222;
      }

      .contact-item.active {
        background: linear-gradient(90deg, #f6fbff, #ffffff);
      }

      body.dark-mode .contact-item.active {
        background: linear-gradient(90deg, #1a2a3a, #222);
      }

      .contact-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        object-fit: cover;
        flex-shrink: 0;
      }
      .contact-info {
        flex: 1;
        min-width: 0;
      }
      .contact-name {
        font-weight: 600;
        font-size: 14px;
        color: var(--text);
      }
      .contact-snippet {
        color: var(--muted);
        font-size: 12px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .contact-time {
        color: var(--muted);
        font-size: 12px;
      }

      .chat-panel {
        background: var(--card);
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        height: calc(100vh - 140px);
        box-shadow: 0 8px 30px rgba(2, 6, 23, 0.06);
        overflow: hidden;
      }
      .chat-header {
        display: flex;
        gap: 12px;
        align-items: center;
        padding: 14px 16px;
        border-bottom: 1px solid #eef2f6;
        color: var(--text);
      }

      body.dark-mode .chat-header {
        border-bottom-color: #333;
      }

      .back-btn{
        display:none;
        background:transparent;
        border:0;
        padding:6px;
        margin-right:4px;
        font-size:16px;
        color:var(--muted);
        cursor:pointer;
      }
      .chat-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        object-fit: cover;
      }
      .chat-name {
        font-weight: 700;
        color: var(--text);
      }
      .chat-status {
        font-size: 12px;
        color: var(--muted);
      }

      .chat-messages {
        flex: 1;
        padding: 18px;
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 12px;
        background: var(--bg);
        min-height: 320px;
      }

      /* Scroll-to-latest floating button */
      .scroll-down-btn {
        position: absolute;
        right: 29px;
        bottom: 131px;
        width: 36px;
        height: 36px;
        border-radius: 10px;
        background: rgba(0,0,0,0.7);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 6px 18px rgba(0,0,0,0.35);
        border: 0;
        cursor: pointer;
        z-index: 50;
        opacity: 0;
        transform: translateY(6px);
        transition: opacity 0.18s ease, transform 0.18s ease, background 0.15s;
        font-size: 18px;
        line-height: 1;
      }

      .scroll-down-btn.visible {
        opacity: 1;
        transform: translateY(0);
      }

      body.dark-mode .scroll-down-btn {
        background: rgba(255,255,255,0.06);
        color: #fff;
      }

      .scroll-down-btn:hover {
        background: rgba(0,0,0,0.85);
      }
      .msg-row {
        display: flex;
        align-items: flex-end;
      }
      .msg-left {
        justify-content: flex-start;
      }
      .msg-right {
        justify-content: flex-end;
      }
      .bubble {
        max-width: 72%;
        padding: 10px 14px;
        border-radius: 18px;
        background: #f2f4f6;
        color: #081226;
        font-size: 14px;
      }

      body.dark-mode .bubble {
        background: #333;
        color: #e0e0e0;
      }

      .bubble.me {
        background: var(--accent);
        color: #fff;
      }
      .msg-meta {
        font-size: 11px;
        color: var(--muted);
        margin-top: 6px;
      }

      .chat-composer {
        display: flex;
        gap: 10px;
        padding: 12px;
        border-top: 1px solid #eef2f6;
        align-items: center;
        position: relative;
      }

      body.dark-mode .chat-composer {
        border-top-color: #333;
      }

      .composer-actions {
        display: flex;
        gap: 8px;
      }

      .composer-btn {
        background: transparent;
        border: none;
        cursor: pointer;
        font-size: 18px;
        color: var(--muted);
        padding: 6px;
        border-radius: 6px;
        transition: background 0.2s;
      }

      .composer-btn:hover {
        background: rgba(0,0,0,0.08);
      }

      body.dark-mode .composer-btn:hover {
        background: rgba(255,255,255,0.08);
      }

      .emoji-picker {
        position: absolute;
        bottom: 54px;
        left: 12px;
        background: var(--card);
        border: 1px solid #eef2f6;
        border-radius: 8px;
        padding: 12px;
        display: none;
        z-index: 100;
        grid-template-columns: repeat(5, 1fr);
        gap: 8px;
        max-height: 200px;
        overflow-y: auto;
        box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      }

      body.dark-mode .emoji-picker {
        border-color: #333;
      }

      .emoji-picker.visible {
        display: grid;
      }

      .emoji-item {
        font-size: 24px;
        cursor: pointer;
        padding: 6px;
        border-radius: 4px;
        transition: background 0.2s;
      }

      .emoji-item:hover {
        background: #f2f4f6;
      }

      body.dark-mode .emoji-item:hover {
        background: #333;
      }

      .composer-input {
        flex: 1;
        border-radius: 22px;
        padding: 10px 14px;
        border: 1px solid #e6edf3;
        outline: none;
        background: var(--card);
        color: var(--text);
      }

      body.dark-mode .composer-input {
        border-color: #333;
        background: #222;
      }

      .send-btn {
        background: var(--accent);
        color: #fff;
        border: 0;
        padding: 8px 14px;
        border-radius: 18px;
        cursor: pointer;
        transition: opacity 0.2s;
      }

      .send-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      /* Small screen: stack and add toggle behavior */
      @media (max-width: 760px) {
        .msger-wrap {
          grid-template-columns: 1fr;
          max-width: 100%;
          padding: 8px;
        }
        .contacts {
          order: 1;
        }
        .chat-panel {
          order: 2;
        }
        .msger-wrap.show-chat .contacts {
          display: none;
        }
        .msger-wrap.show-contacts .chat-panel {
          display: none;
        }
        .back-btn{ display:inline-flex; align-items:center; justify-content:center }
        .chat-panel {
          height: calc(100vh - 170px);
        }
        .theme-toggle {
          top: 70px;
          right: 10px;
        }
        .scroll-down-btn {
          bottom: 167px;
        }
      }
    </style>
</head>
  <body>
    <!-- Header -->
    <header class="header">
      <!-- Left section -->
      <div class="header-left">
        <div class="logo">
          <i class="fab fa-facebook"></i>
        </div>
        <div class="search-bar">
          <i class="fas fa-search"></i>
          <input type="text" placeholder="Search Facebook" />
        </div>
      </div>

      <!-- Center navigation -->
      <div class="header-center">
        <a href="{% url 'Homepage' %}" class="nav-icon active">
          <i class="fas fa-home"></i>
        </a>
        <a href="video_page" class="nav-icon">
          <i class="fas fa-play"></i>
        </a>
        <a href="market_page" class="nav-icon">
          <i class="fas fa-store"></i>
        </a>
        <a href="friends_page" class="nav-icon">
          <i class="fas fa-users"></i>
        </a>
        <a href="#" class="nav-icon">
          <i class="fas fa-gamepad"></i>
        </a>
      </div>

      <!-- Right section -->
      <div class="header-right">
        <div class="action-button">
          <i class="fas fa-plus"></i>
        </div>
        <div class="action-button">
          <a href="message_page" style="color:#aaa;"><i class="fab fa-facebook-messenger"></i></a>
        </div>
        <div class="action-button">
          <a href="requests_page" style="color:#aaa;"><i class="fas fa-bell"></i></a>
        </div>
        <div class="user-profile">
          <a href="{% url 'User_Profile' %}"
            ><img src="{% static "image/contact1.jpeg" %}" alt="Profile"></a
          >
        </div>
      </div>
    </header>
    <br />
    <br />
    <br />

    <!-- Dark Mode Toggle -->
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode">
      <span id="themeIcon">üåô</span> Dark
    </button>

    <div class="chat-container">
      <div class="msger-wrap" id="msgerWrap">
        <div class="contacts">
          <div class="contacts-header"><h3>Messages</h3></div>
          <div class="contacts-list">
            {% for friend in friends %}
              <div class="contact-item" data-id="{{ friend.id }}" onclick="openConversation({{ friend.id }}, this, event)">
                <img class="contact-avatar" src="{% static 'image/contact1.jpeg' %}" alt="{{ friend.get_full_name }}">
                <div class="contact-info">
                  <div class="contact-name">{{ friend.get_full_name|default:friend.username }}</div>
                  <div class="contact-snippet">
                    {% if conversations|get_item:friend.id %}
                      {{ conversations|get_item:friend.id|get_item:'last_message'|truncatewords:3 }}
                    {% else %}
                      No messages yet
                    {% endif %}
                  </div>
                </div>
              </div>
            {% empty %}
              <div style="padding:12px;color:#6b7280;text-align:center">No friends yet. Add friends to start messaging!</div>
            {% endfor %}
          </div>
        </div>
        <div class="chat-panel">
          <div class="chat-header">
            <button id="backBtn" class="back-btn" aria-label="Back to contacts"><i class="fas fa-arrow-left"></i></button>
            <img id="chatAvatar" class="chat-avatar" src="{% static 'image/contact1.jpeg' %}" alt="avatar" />
            <div>
              <div id="chatName" class="chat-name">Select a conversation</div>
              <div class="chat-status">Active now</div>
            </div>
          </div>
          <div id="chatMessages" class="chat-messages"></div>
          <button id="scrollDownBtn" class="scroll-down-btn" title="Go to latest">‚¨á</button>
          <div class="chat-composer">
            <div class="composer-actions">
              <button class="composer-btn" id="emojiBtn" title="Emoji">üòä</button>
              <button class="composer-btn" id="fileBtn" title="Attach file">üìé</button>
              <button class="composer-btn" id="docBtn" title="Attach document">üìÑ</button>
            </div>
            <div id="emojiPicker" class="emoji-picker">
              <div class="emoji-item">üòä</div>
              <div class="emoji-item">üòÇ</div>
              <div class="emoji-item">‚ù§Ô∏è</div>
              <div class="emoji-item">üëç</div>
              <div class="emoji-item">üéâ</div>
              <div class="emoji-item">üî•</div>
              <div class="emoji-item">üíØ</div>
              <div class="emoji-item">üòç</div>
              <div class="emoji-item">üò¢</div>
              <div class="emoji-item">üò°</div>
              <div class="emoji-item">üëè</div>
              <div class="emoji-item">üôè</div>
              <div class="emoji-item">üòé</div>
              <div class="emoji-item">ü§î</div>
              <div class="emoji-item">üò¥</div>
            </div>
            <input id="composerInput" class="composer-input" placeholder="Type a message..." />
            <button id="sendBtn" class="send-btn">Send</button>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>

<script>
  {% load custom_filters %}
  
  // ===== DARK MODE =====
  function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    document.documentElement.classList.toggle('dark-mode');
    localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    updateThemeIcon();
  }

  function updateThemeIcon() {
    const icon = document.getElementById('themeIcon');
    if (document.body.classList.contains('dark-mode')) {
      icon.textContent = '‚òÄÔ∏è';
    } else {
      icon.textContent = 'üåô';
    }
  }

  // Load saved theme preference on page load
  function initTheme() {
    if (localStorage.getItem('theme') === 'dark') {
      document.body.classList.add('dark-mode');
      document.documentElement.classList.add('dark-mode');
    } else {
      document.body.classList.remove('dark-mode');
      document.documentElement.classList.remove('dark-mode');
    }
    updateThemeIcon();
  }

  // Initialize theme immediately
  initTheme();

  // ===== BROWSER NOTIFICATIONS =====
  function requestNotificationPermission() {
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }
  }

  function showNotification(title, options = {}) {
    if ('Notification' in window && Notification.permission === 'granted') {
      new Notification(title, {
        icon: '{% static "image/contact1.jpeg" %}',
        ...options
      });
    }
  }

  // Request notification permission on load
  window.addEventListener('load', requestNotificationPermission);

  // ===== MESSAGING =====
  
  // Friends data from server (passed in template context)
  const friendsData = [
    {% for friend in friends %}
      {
        id: {{ friend.id }},
        name: "{{ friend.get_full_name|default:friend.username|escapejs }}",
        avatar: '{% static "image/contact1.jpeg" %}',
      }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];

  const msgerWrap = document.getElementById("msgerWrap");
  const chatName = document.getElementById("chatName");
  const chatAvatar = document.getElementById("chatAvatar");
  const backBtn = document.getElementById('backBtn');
  const chatMessages = document.getElementById("chatMessages");
  const composerInput = document.getElementById("composerInput");
  const sendBtn = document.getElementById("sendBtn");
  const scrollDownBtn = document.getElementById('scrollDownBtn');
  const emojiBtn = document.getElementById('emojiBtn');
  const emojiPicker = document.getElementById('emojiPicker');
  const fileBtn = document.getElementById('fileBtn');
  const docBtn = document.getElementById('docBtn');
  const emojiItems = document.querySelectorAll('.emoji-item');

  let activeConv = null;
  let messagePollingInterval = null;
  const messageIds = new Set(); // Track message IDs to avoid duplicates
  let autoScrollEnabled = true; // when true, new messages auto-scroll to bottom

  function getCookie(name) {
    const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
  }

  // Load messages from API for a friend
  async function loadMessages(friendId) {
    try {
      const res = await fetch(`/api/get_messages/?friend_id=${friendId}`, {
        credentials: 'same-origin'
      });
      if (res.ok) {
        const data = await res.json();
        console.debug('Loaded messages for', friendId, 'count=', data.length);
        return data;
      } else {
        console.warn('Failed to load messages, status=', res.status);
      }
    } catch (e) {
      console.error('Failed to load messages', e);
    }
    return [];
  }

  function appendMessage(from, text, time, msgId) {
    // Avoid duplicate messages
    if (msgId && messageIds.has(msgId)) return;
    if (msgId) messageIds.add(msgId);

    const container = document.createElement("div");
    container.className = "msg-wrapper";
    
    const row = document.createElement("div");
    row.className = "msg-row " + (from === "me" ? "msg-right" : "msg-left");
    
    const bubble = document.createElement("div");
    bubble.className = "bubble " + (from === "me" ? "me" : "");
    bubble.textContent = text;
    row.appendChild(bubble);
    
    const meta = document.createElement("div");
    meta.className = "msg-meta";
    meta.textContent = time || "";
    
    container.appendChild(row);
    container.appendChild(meta);
    chatMessages.appendChild(container);
    
    // If auto-scroll is enabled, scroll to bottom. Otherwise show scroll button.
    setTimeout(() => {
      if (autoScrollEnabled) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      } else if (scrollDownBtn) {
        scrollDownBtn.classList.add('visible');
      }
    }, 0);

    // Show notification for incoming messages
    if (from === "them" && msgId && activeConv) {
      showNotification(`Message from ${activeConv.name}`, {
        body: text.substring(0, 50),
        tag: `msg-${msgId}`
      });
    }
  }

  // Refresh messages silently (no full page reload)
  async function refreshMessages() {
    if (!activeConv) return; // Only refresh if a conversation is open
    const messages = await loadMessages(activeConv.id);
    // Rebuild the entire message list each refresh to ensure older messages appear
    chatMessages.innerHTML = '';
    messageIds.clear();
    console.debug('Rebuilding messages view, total=', messages.length);
    messages.forEach(m => {
      appendMessage(m.from_me ? "me" : "them", m.text, m.time, m.id);
    });
    // If autoScrollEnabled, ensure view is at bottom after rebuild
    if (autoScrollEnabled) {
      setTimeout(() => { chatMessages.scrollTop = chatMessages.scrollHeight; }, 0);
    }
  }

  // Start polling for new messages when conversation opens
  function startMessagePolling() {
    if (messagePollingInterval) clearInterval(messagePollingInterval);
    messagePollingInterval = setInterval(() => {
      refreshMessages();
    }, 5000); // Poll every 5 seconds
  }

  // Stop polling when conversation closes
  function stopMessagePolling() {
    if (messagePollingInterval) {
      clearInterval(messagePollingInterval);
      messagePollingInterval = null;
    }
  }

  function openConversation(friendId, el, e) {
    if (e) e.preventDefault();
    
    activeConv = friendsData.find(f => f.id === friendId);
    if (!activeConv) return;

    // Mark active
    Array.from(document.querySelectorAll(".contact-item")).forEach(i => i.classList.remove("active"));
    if (el) el.classList.add("active");

    chatName.textContent = activeConv.name;
    chatAvatar.src = activeConv.avatar;
    chatMessages.innerHTML = '<div style="text-align:center;color:var(--muted)">Loading messages...</div>';
    messageIds.clear(); // Clear message tracking
    // Opening a conversation enables auto-scroll by default
    autoScrollEnabled = true;
    if (scrollDownBtn) scrollDownBtn.classList.remove('visible');

    // Load messages from API
    loadMessages(friendId).then(messages => {
      chatMessages.innerHTML = '';
      messages.forEach(m => {
        appendMessage(m.from_me ? "me" : "them", m.text, m.time, m.id);
      });
      if (autoScrollEnabled) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
      startMessagePolling(); // Start polling when chat opens
    });

    // On small screens, show chat
    if (window.innerWidth <= 760 && msgerWrap) {
      msgerWrap.classList.remove('show-contacts');
      msgerWrap.classList.add("show-chat");
    }
  }

  sendBtn.addEventListener("click", () => {
    if (!activeConv) return;
    const text = composerInput.value.trim();
    if (!text) return;

    const csrftoken = getCookie('csrftoken');
    const body = new URLSearchParams();
    body.append('to_id', String(activeConv.id));
    body.append('text', text);

    // Disable button to prevent double-send
    sendBtn.disabled = true;
    composerInput.disabled = true;

    fetch('/api/send_message/', {
      method: 'POST',
      credentials: 'same-origin',
      headers: {
        'X-CSRFToken': csrftoken,
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: body.toString(),
    }).then(res => {
      if (res.ok) {
        composerInput.value = "";
        // Reload messages from API (only load from server, don't duplicate)
        // re-enable auto-scroll when user sends a message so sender sees it immediately
        autoScrollEnabled = true;
        if (scrollDownBtn) scrollDownBtn.classList.remove('visible');
        setTimeout(() => {
          loadMessages(activeConv.id).then(messages => {
            chatMessages.innerHTML = ''; // Clear all
            messageIds.clear();
            messages.forEach(m => {
              appendMessage(m.from_me ? "me" : "them", m.text, m.time, m.id);
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;
            startMessagePolling(); // Restart polling
          });
        }, 300);
      } else {
        alert('Failed to send message');
      }
    }).catch(e => {
      console.error('Send error', e);
      alert('Network error');
    }).finally(() => {
      // Re-enable button
      sendBtn.disabled = false;
      composerInput.disabled = false;
      composerInput.focus();
    });
  });

  composerInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendBtn.click();
    }
  });

  // Back button for mobile
  if (backBtn) {
    backBtn.addEventListener('click', () => {
      if (window.innerWidth <= 760 && msgerWrap) {
        msgerWrap.classList.remove('show-chat');
        msgerWrap.classList.add('show-contacts');
        stopMessagePolling(); // Stop polling when going back to contacts
      }
    });
  }

  // Scroll handling: show/hide scroll-to-latest button based on user's scroll position
  if (chatMessages && scrollDownBtn) {
    chatMessages.addEventListener('scroll', () => {
      const distanceFromBottom = chatMessages.scrollHeight - chatMessages.scrollTop - chatMessages.clientHeight;
      const nearBottom = distanceFromBottom <= 60;
      if (nearBottom) {
        // user at/near bottom - hide button and allow auto-scroll
        autoScrollEnabled = true;
        scrollDownBtn.classList.remove('visible');
      } else {
        // user scrolled up - disable auto-scroll and show button
        autoScrollEnabled = false;
        scrollDownBtn.classList.add('visible');
      }
    });

    // Click the button to scroll to bottom and re-enable auto-scroll
    scrollDownBtn.addEventListener('click', () => {
      autoScrollEnabled = true;
      chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: 'smooth' });
      scrollDownBtn.classList.remove('visible');
    });
  }

  // Emoji picker toggle
  emojiBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    emojiPicker.classList.toggle('visible');
  });

  // Insert emoji into input
  emojiItems.forEach(item => {
    item.addEventListener('click', () => {
      composerInput.value += item.textContent;
      composerInput.focus();
      emojiPicker.classList.remove('visible');
    });
  });

  // Close emoji picker when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('#emojiBtn') && !e.target.closest('#emojiPicker')) {
      emojiPicker.classList.remove('visible');
    }
  });

  // File attachment handling
  fileBtn.addEventListener('click', () => {
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '*/*';
    fileInput.addEventListener('change', () => {
      if (fileInput.files[0]) {
        const fileName = fileInput.files[0].name;
        composerInput.value += ` [üìé ${fileName}]`;
        composerInput.focus();
      }
    });
    fileInput.click();
  });

  // Document attachment handling
  docBtn.addEventListener('click', () => {
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.pdf,.doc,.docx,.txt,.xls,.xlsx,.ppt,.pptx';
    fileInput.addEventListener('change', () => {
      if (fileInput.files[0]) {
        const fileName = fileInput.files[0].name;
        composerInput.value += ` [üìÑ ${fileName}]`;
        composerInput.focus();
      }
    });
    fileInput.click();
  });

  // On resize
  window.addEventListener("resize", () => {
    if (window.innerWidth > 760 && msgerWrap) {
      msgerWrap.classList.remove("show-chat");
      msgerWrap.classList.remove("show-contacts");
    }
  });

  // Stop polling when user leaves the page
  window.addEventListener("beforeunload", () => {
    stopMessagePolling();
  });
</script>
