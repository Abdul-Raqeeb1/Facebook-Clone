{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Messages</title>
    <link rel="stylesheet" href="{% static 'css/facebookhome.css' %}" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <style>
      /* Messenger layout styles */
      :root {
        --bg: #f1f5f7;
        --card: #ffffff;
        --muted: #6b7280;
        --accent: #0b84ff;
      }

      body {
        background: var(--bg);
        font-family: Inter, system-ui, Arial, sans-serif;
        color: #0b1220;
      }

      .spacer {
        height: 20px;
      }

      /* Two-panel layout: fixed contacts column + flexible chat column. Full-width on desktop. */
      .msger-wrap {
        width: 100%;
        max-width: none;
        margin: 12px 0;
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 12px;
        padding: 12px;
        box-sizing: border-box;
      }

      .contacts {
        background: var(--card);
        border-radius: 12px;
        box-shadow: 0 8px 30px rgba(2, 6, 23, 0.06);
        overflow: hidden;
        height: calc(100vh - 140px);
      }
      .contacts-header {
        padding: 18px 18px 8px 18px;
        border-bottom: 1px solid #eef2f6;
      }
      .contacts-header h3 {
        margin: 0;
        font-size: 18px;
      }

      .contacts-list {
        height: calc(100% - 72px);
        overflow: auto;
      }
      .contact-item {
        display: flex;
        gap: 12px;
        padding: 12px 16px;
        align-items: center;
        cursor: pointer;
        border-bottom: 1px solid #f2f4f6;
      }
      .contact-item.active {
        background: linear-gradient(90deg, #f6fbff, #ffffff);
      }
      .contact-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        object-fit: cover;
        flex-shrink: 0;
      }
      .contact-info {
        flex: 1;
        min-width: 0;
      }
      .contact-name {
        font-weight: 600;
        font-size: 14px;
        color: #081226;
      }
      .contact-snippet {
        color: var(--muted);
        font-size: 12px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .contact-time {
        color: var(--muted);
        font-size: 12px;
      }

      .chat-panel {
        background: var(--card);
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        height: calc(100vh - 140px);
        box-shadow: 0 8px 30px rgba(2, 6, 23, 0.06);
        overflow: hidden;
      }
      .chat-header {
        display: flex;
        gap: 12px;
        align-items: center;
        padding: 14px 16px;
        border-bottom: 1px solid #eef2f6;
      }
      .back-btn{
        display:none;
        background:transparent;
        border:0;
        padding:6px;
        margin-right:4px;
        font-size:16px;
        color:var(--muted);
        cursor:pointer;
      }
      .chat-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        object-fit: cover;
      }
      .chat-name {
        font-weight: 700;
      }
      .chat-status {
        font-size: 12px;
        color: var(--muted);
      }

      .chat-messages {
        flex: 1;
        padding: 18px;
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 12px;
        background: linear-gradient(#fff, #fff);
        min-height: 320px;
      }
      .msg-row {
        display: flex;
        align-items: flex-end;
      }
      .msg-left {
        justify-content: flex-start;
      }
      .msg-right {
        justify-content: flex-end;
      }
      .bubble {
        max-width: 72%;
        padding: 10px 14px;
        border-radius: 18px;
        background: #f2f4f6;
        color: #081226;
        font-size: 14px;
      }
      .bubble.me {
        background: var(--accent);
        color: #fff;
      }
      .msg-meta {
        font-size: 11px;
        color: var(--muted);
        margin-top: 6px;
      }

      .chat-composer {
        display: flex;
        gap: 10px;
        padding: 12px;
        border-top: 1px solid #eef2f6;
        align-items: center;
      }
      .composer-input {
        flex: 1;
        border-radius: 22px;
        padding: 10px 14px;
        border: 1px solid #e6edf3;
        outline: none;
      }
      .send-btn {
        background: var(--accent);
        color: #fff;
        border: 0;
        padding: 8px 14px;
        border-radius: 18px;
        cursor: pointer;
      }

      /* Small screen: stack and add toggle behavior */
      @media (max-width: 760px) {
        .msger-wrap {
          grid-template-columns: 1fr;
          max-width: 100%;
          padding: 8px;
        }
        .contacts {
          order: 1;
        }
        .chat-panel {
          order: 2;
        }
        .msger-wrap.show-chat .contacts {
          display: none;
        }
        .msger-wrap.show-contacts .chat-panel {
          display: none;
        }
        .back-btn{ display:inline-flex; align-items:center; justify-content:center }
        .chat-panel {
          height: calc(100vh - 170px);
        }
      }
    </style>
</head>
  <body>
    <!-- Header -->
    <header class="header">
      <!-- Left section -->
      <div class="header-left">
        <div class="logo">
          <i class="fab fa-facebook"></i>
        </div>
        <div class="search-bar">
          <i class="fas fa-search"></i>
          <input type="text" placeholder="Search Facebook" />
        </div>
      </div>

      <!-- Center navigation -->
      <div class="header-center">
        <a href="{% url 'Homepage' %}" class="nav-icon active">
          <i class="fas fa-home"></i>
        </a>
        <a href="video_page" class="nav-icon">
          <i class="fas fa-play"></i>
        </a>
        <a href="market_page" class="nav-icon">
          <i class="fas fa-store"></i>
        </a>
        <a href="friends_page" class="nav-icon">
          <i class="fas fa-users"></i>
        </a>
        <a href="#" class="nav-icon">
          <i class="fas fa-gamepad"></i>
        </a>
      </div>

      <!-- Right section -->
      <div class="header-right">
        <div class="action-button">
          <i class="fas fa-plus"></i>
        </div>
        <div class="action-button">
          <a href="message_page"><i class="fab fa-facebook-messenger"></i></a>
        </div>
        <div class="action-button">
          <a href="requests_page"><i class="fas fa-bell"></i></a>
        </div>
        <div class="user-profile">
          <a href="{% url 'User_Profile' %}"
            ><img src="{% static "image/contact1.jpeg" %}" alt="Profile"></a
          >
        </div>
      </div>
    </header>
    <br />
    <br />
    <br />

    <div class="chat-container">
      <div class="msger-wrap" id="msgerWrap">
        <div class="contacts">
          <div class="contacts-header"><h3>Messages</h3></div>
          <div class="contacts-list">
            {% for friend in friends %}
              <div class="contact-item" data-id="{{ friend.id }}" onclick="openConversation({{ friend.id }}, this, event)">
                <img class="contact-avatar" src="{% static 'image/contact1.jpeg' %}" alt="{{ friend.get_full_name }}">
                <div class="contact-info">
                  <div class="contact-name">{{ friend.get_full_name|default:friend.username }}</div>
                  <div class="contact-snippet">
                    {% if conversations|get_item:friend.id %}
                      {{ conversations|get_item:friend.id|get_item:'last_message'|truncatewords:3 }}
                    {% else %}
                      No messages yet
                    {% endif %}
                  </div>
                </div>
              </div>
            {% empty %}
              <div style="padding:12px;color:#6b7280;text-align:center">No friends yet. Add friends to start messaging!</div>
            {% endfor %}
          </div>
        </div>
        <div class="chat-panel">
          <div class="chat-header">
            <button id="backBtn" class="back-btn" aria-label="Back to contacts"><i class="fas fa-arrow-left"></i></button>
            <img id="chatAvatar" class="chat-avatar" src="{% static 'image/contact1.jpeg' %}" alt="avatar" />
            <div>
              <div id="chatName" class="chat-name">Select a conversation</div>
              <div class="chat-status">Active now</div>
            </div>
          </div>
          <div id="chatMessages" class="chat-messages"></div>
          <div class="chat-composer">
            <input id="composerInput" class="composer-input" placeholder="Type a message..." />
            <button id="sendBtn" class="send-btn">Send</button>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>

<script>
  {% load custom_filters %}
  
  // Friends data from server (passed in template context)
  const friendsData = [
    {% for friend in friends %}
      {
        id: {{ friend.id }},
        name: "{{ friend.get_full_name|default:friend.username|escapejs }}",
        avatar: '{% static "image/contact1.jpeg" %}',
      }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];

  const msgerWrap = document.getElementById("msgerWrap");
  const chatName = document.getElementById("chatName");
  const chatAvatar = document.getElementById("chatAvatar");
  const backBtn = document.getElementById('backBtn');
  const chatMessages = document.getElementById("chatMessages");
  const composerInput = document.getElementById("composerInput");
  const sendBtn = document.getElementById("sendBtn");

  let activeConv = null;
  let messagePollingInterval = null;
  const messageIds = new Set(); // Track message IDs to avoid duplicates

  function getCookie(name) {
    const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
  }

  // Load messages from API for a friend
  async function loadMessages(friendId) {
    try {
      const res = await fetch(`/api/get_messages/?friend_id=${friendId}`, {
        credentials: 'same-origin'
      });
      if (res.ok) {
        return await res.json();
      }
    } catch (e) {
      console.error('Failed to load messages', e);
    }
    return [];
  }

  function appendMessage(from, text, time, msgId) {
    // Avoid duplicate messages
    if (msgId && messageIds.has(msgId)) return;
    if (msgId) messageIds.add(msgId);

    const row = document.createElement("div");
    row.className = "msg-row " + (from === "me" ? "msg-right" : "msg-left");
    const bubble = document.createElement("div");
    bubble.className = "bubble " + (from === "me" ? "me" : "");
    bubble.textContent = text;
    row.appendChild(bubble);
    const meta = document.createElement("div");
    meta.className = "msg-meta";
    meta.textContent = time || "";
    const container = document.createElement("div");
    container.appendChild(row);
    container.appendChild(meta);
    chatMessages.appendChild(container);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // Refresh messages silently (no full page reload)
  async function refreshMessages() {
    if (!activeConv) return; // Only refresh if a conversation is open
    
    const messages = await loadMessages(activeConv.id);
    messages.forEach(m => {
      appendMessage(m.from_me ? "me" : "them", m.text, m.time, m.id);
    });
  }

  // Start polling for new messages when conversation opens
  function startMessagePolling() {
    if (messagePollingInterval) clearInterval(messagePollingInterval);
    messagePollingInterval = setInterval(() => {
      refreshMessages();
    }, 5000); // Poll every 5 seconds
  }

  // Stop polling when conversation closes
  function stopMessagePolling() {
    if (messagePollingInterval) {
      clearInterval(messagePollingInterval);
      messagePollingInterval = null;
    }
  }

  function openConversation(friendId, el, e) {
    if (e) e.preventDefault();
    
    activeConv = friendsData.find(f => f.id === friendId);
    if (!activeConv) return;

    // Mark active
    Array.from(document.querySelectorAll(".contact-item")).forEach(i => i.classList.remove("active"));
    if (el) el.classList.add("active");

    chatName.textContent = activeConv.name;
    chatAvatar.src = activeConv.avatar;
    chatMessages.innerHTML = '<div style="text-align:center;color:#6b7280">Loading messages...</div>';
    messageIds.clear(); // Clear message tracking

    // Load messages from API
    loadMessages(friendId).then(messages => {
      chatMessages.innerHTML = '';
      messages.forEach(m => {
        appendMessage(m.from_me ? "me" : "them", m.text, m.time, m.id);
      });
      chatMessages.scrollTop = chatMessages.scrollHeight;
      startMessagePolling(); // Start polling when chat opens
    });

    // On small screens, show chat
    if (window.innerWidth <= 760 && msgerWrap) {
      msgerWrap.classList.remove('show-contacts');
      msgerWrap.classList.add("show-chat");
    }
  }

  sendBtn.addEventListener("click", () => {
    if (!activeConv) return;
    const text = composerInput.value.trim();
    if (!text) return;

    const csrftoken = getCookie('csrftoken');
    const body = new URLSearchParams();
    body.append('to_id', String(activeConv.id));
    body.append('text', text);

    // Disable button to prevent double-send
    sendBtn.disabled = true;
    composerInput.disabled = true;

    fetch('/api/send_message/', {
      method: 'POST',
      credentials: 'same-origin',
      headers: {
        'X-CSRFToken': csrftoken,
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: body.toString(),
    }).then(res => {
      if (res.ok) {
        composerInput.value = "";
        // Reload messages from API (only load from server, don't duplicate)
        setTimeout(() => {
          loadMessages(activeConv.id).then(messages => {
            chatMessages.innerHTML = ''; // Clear all
            messageIds.clear();
            messages.forEach(m => {
              appendMessage(m.from_me ? "me" : "them", m.text, m.time, m.id);
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;
            startMessagePolling(); // Restart polling
          });
        }, 300);
      } else {
        alert('Failed to send message');
      }
    }).catch(e => {
      console.error('Send error', e);
      alert('Network error');
    }).finally(() => {
      // Re-enable button
      sendBtn.disabled = false;
      composerInput.disabled = false;
    });
  });

  composerInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendBtn.click();
    }
  });

  // Back button for mobile
  if (backBtn) {
    backBtn.addEventListener('click', () => {
      if (window.innerWidth <= 760 && msgerWrap) {
        msgerWrap.classList.remove('show-chat');
        msgerWrap.classList.add('show-contacts');
        stopMessagePolling(); // Stop polling when going back to contacts
      }
    });
  }

  // On resize
  window.addEventListener("resize", () => {
    if (window.innerWidth > 760 && msgerWrap) {
      msgerWrap.classList.remove("show-chat");
      msgerWrap.classList.remove("show-contacts");
    }
  });

  // Stop polling when user leaves the page
  window.addEventListener("beforeunload", () => {
    stopMessagePolling();
  });
</script>
